on:
    push: # triggers on any push
    workflow_dispatch: # manual trigger via GitHub UI

jobs:
    maven-test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Set up Java
              uses: actions/setup-java@v5
              with:
                  distribution: "graalvm"
                  java-version: "25"
                  cache: maven

            - name: Build with Maven
              run: ./mvnw --batch-mode test

            - name: Generate JaCoCo Badge
              uses: cicirello/jacoco-badge-generator@v2
              with:
                  generate-branches-badge: true

            - name: Commit the badge (if it changed)
              run: |
                  if [[ `git status --porcelain` ]]; then
                    git config --global user.name 'github-actions[bot]'
                    git config --global user.email 'github-actions[bot]@users.noreply.github.com'
                    git add -A
                    git commit -m "Autogenerated JaCoCo coverage badge"
                    git push
                  fi

            - name: Upload JaCoCo coverage report
              uses: actions/upload-artifact@v4
              with:
                  name: jacoco-report
                  path: target/site/jacoco/
